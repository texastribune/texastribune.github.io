<!DOCTYPE html>
<html lang="en">
    <head>
        <title>Texas Tribune Engineering</title>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <link rel="icon" type="image/png" sizes="48x48" href="https://www.texastribune.org/static/images/favicon-48x48.png">
        <link rel="icon" type="image/png" sizes="32x32" href="https://www.texastribune.org/static/images/favicon-32x32.png">
        <link rel="icon" type="image/png" sizes="16x16" href="https://www.texastribune.org/static/images/favicon-16x16.png">
        <link rel="apple-touch-icon" sizes="180x180" href="https://www.texastribune.org/static/images/apple-touch-icon.png">
        <meta name="Description" content="Open source projects and blog posts by the Texas Tribune's engineering team.">
        <link rel="stylesheet" href=/css/style.css>
        
    </head>
    <body>
        <div class="page-container">
            <div class="content-wrap">
                <header class= "has-bg-white-off">
    <nav aria-label="primary" class="c-navbar c-navbar--dark has-bg-black-off">
        <div class="c-navbar__top">
            <div class="has-bg-black-off" style="width:70%"></div>
            <div class="c-navbar__content c-navbar__content--home">
                <ul class="c-navbar__items t-uppercase">
                    <li class="c-navbar__item">
                        <a class="c-navbar__item-content c-navbar__clickable c-navbar__clickable--animated  t-size-xxs" href="/">
                            <strong>Home</strong>
                        </a>
                    </li>
                    <li class="c-navbar__item">
                        <a class="c-navbar__item-content c-navbar__clickable c-navbar__clickable--animated  t-size-xxs" href="/about">
                            <strong>About</strong>
                        </a>
                    </li>
                    <li class="c-navbar__item">
                        <a class="c-navbar__item-content c-navbar__clickable c-navbar__clickable--animated  t-size-xxs" href="/posts">
                            <strong>Blog</strong>
                        </a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>
    <a href="/">
        <div class="banner">
            <div class="banner-items has-xl-padding t-align-center has-text-black-off t-lsp-m t-size-b">
                <div class="logo-container">
                    <svg aria-hidden="true" xmlns='http://www.w3.org/2000/svg' viewBox='0 0 585.7 64.51'><path fill="#222" d='M84.94 10.23v45.85H74.63V10.23H64.49V1.16H95v9.07zM120.08 56.08V33.57h-11.46v22.51H98.39V1.16h10.23v23.25h11.46V1.16h10.31v54.92zM136.78 56.08V1.16H163V10h-16v13.59h11.05v8.08H147v15.26h16v9.15zM198.62 10.23v45.85h-10.31V10.23h-10.14V1.16h30.51v9.07zM213.1 56.08V1.16h26.23V10h-16v13.59h11v8.08h-11v15.26h16v9.15zM265.89 56.08l-6.44-19-7 19h-10l11.29-27.71-10.62-27.21h10.73l6 19 6.59-19h10.07l-11 26.39 11.05 28.53zM301.7 56.08l-1.81-10.8h-9.73l-2 10.8h-9.57l11.07-54.92h11.47l11 54.92zM295.27 16l-3.71 21.2h7zM328.66 57.32c-9.4 0-15.25-5.61-15.25-14.19v-3.79h9.4v3.22c0 4 1.9 6.26 5.61 6.26s5.44-2.14 5.44-5.52c0-4.37-2.8-7.34-8.25-11.38-5.6-4-11.71-9.49-11.71-17.15C313.9 6.85 319 0 328.91 0c8.66 0 14.43 5.94 14.43 14.1v3.55H334v-3.3c0-3.38-1.72-5.85-5.19-5.85a4.63 4.63 0 0 0-4.95 4.94c0 4.62 2.72 7 8.82 11.47 6.52 4.86 11.14 9.81 11.14 17.23.02 8.86-6.08 15.18-15.16 15.18zM377.84 10.23v45.85h-10.31V10.23h-10.15V1.16h30.52v9.07zM417.57 56.41c-4.05 0-5.61-3.3-5.61-8.08V38c0-2.56-1.32-4.7-4.21-4.7h-5.36v22.78h-10.22V1.16h16.9c7.51 0 12.54 4.29 12.54 12v7.76c0 4.12-1.9 7.17-6.19 8.49a8.42 8.42 0 0 1 6.35 8.33v10.01a7.69 7.69 0 0 0 2 5.61v3zm-5.94-42.88c0-2.48-1.07-4-3.63-4h-5.61v16.2h5.2c2.64 0 4-1.4 4-4.37zM429.8 56.08V1.16H440v54.92zM465.59 56.08h-17.32V1.16h17.16c7.5 0 12.12 4 12.12 11.62v5.94c0 4.7-1.81 8.25-6.51 9.24 4.95 1.32 6.76 4.7 6.76 9.32v7.17c0 7.67-4.7 11.63-12.21 11.63zm2.15-42.55c0-2.48-1.08-4-3.63-4h-5.53v15.13h5.12c2.63 0 4-1.4 4-4.29zm.16 23c0-2.89-1.4-4.37-4-4.37h-5.28v15.5h5.78c2.55 0 3.54-1.4 3.54-4zM499.34 57.32c-8.9 0-15.5-5.69-15.5-13.94V1.16h10.39v42.22c0 3.22 1.81 5 5.11 5s5.2-1.81 5.2-5V1.16h10v42.22c-.02 8.25-6.29 13.94-15.2 13.94zM544.66 56.08L534 32.66l-3.87-8.74v32.16h-9.4V1.16h8.82L539.71 25l3.63 8.74V1.16h9.24v54.92zM559.48 56.08V1.16h26.22V10h-16v13.59h11v8.08h-11v15.26h16v9.15z'/><path d='M0 .6v63.91l12.85-8h43V.6zm40 44.63l-12.22-8.06-12.24 8.06 3.88-14.13L8 22l14.63-.68 5.15-13.76L33 21.27l14.58.73-11.44 9.1z' fill='#ffc200'/></svg>            
                </div>
                <div id="typewriter" class="t-sans" aria-hidden="true">
                    <script src="/assets/main.js"></script>
                    <noscript> &lt engineering / &gt </noscript>
                </div>
            </div>
        </div>
    </a>
</header>


                <link href="https://unpkg.com/prismjs@1.20.0/themes/prism-okaidia.css" rel="stylesheet"
<main>
  <article>
    <h1 class="post__title t-serif t-size-xxl">What year is it? The tech behind our date watermarks</h1>
    <div class="post__description">
      <p class="has-vert-bar t-size-m has-text-yellow">
      <span class="has-text-gray-dark">
        In February 2021, The Texas Tribune engineering team rolled out a feature that will overlay the publish year on the share image of old articles.
      </span>
      </p>
    </div>
    <p class="post__byline t-byline has-text-gray">
      <span class="t-byline__item l-display-ib">By Ashley Hebler </span>
      <time class="t-byline__item l-display-ib"> Feb 23, 2021</time>
    </p>
    <figure class="post__image has-xxl-btm-marg">
        <img src="/images/posts/date-labels.jpg" alt="Four different Texas-inspired images each with a small rectangle in upper right, indicating a year." >
    </figure>
    <div class="post__content c-story-body">
        <p>In February 2021, The Texas Tribune engineering team rolled out a feature that adds timestamps of the publish year on the images shared (og:images) along with our articles. In this post, we'll take a look at that process.</p>
<p>Many ideas for our products start with a simple Slack message.</p>
<figure>
  <img src="/images/posts/date-labels-slack.jpg" alt="Screenshot of an internal Slack post, in which a Tweet is linked with the comment, 'One of the most effective ways of combatting a certain kind of misinformation.'">
  <figcaption>The Texas Tribune's Editorial Director, Stacy-Marie Ishmael, shares product inspiration in our #engineering Slack channel.</figcaption>
</figure>
<p>In the Tweet, <a href="https://twitter.com/ylichterman">@ylichterman</a> observed that The New York Times started adding date labels to their posts and the tweet also linked out to <a href="https://www.niemanlab.org/2019/04/the-guardians-nifty-old-article-trick-is-a-reminder-of-how-news-organizations-can-use-metadata-to-limit-misinformation/">this Guardian post on the subject</a>. The Guardian generously open sources their front-end, which allowed us to get some perspective on one technical implementation example.</p>
<blockquote class="twitter-tweet"><p lang="en" dir="ltr">Basically we use an overlay capability from our CDN image service <a href="https://twitter.com/fastly?ref_src=twsrc%5Etfw">@fastly</a> to generate a specific image to serves as opengraph metadata. Because we develop in the open, anyone can look at the details here <a href="https://t.co/Hm1VLdfeL7">https://t.co/Hm1VLdfeL7</a></p>&mdash; Mariot Chauvin (@mchv) <a href="https://twitter.com/mchv/status/1113500575767961600?ref_src=twsrc%5Etfw">April 3, 2019</a></blockquote> <script async src="https://platform.twitter.com/widgets.js" charset="utf-8"></script>
<p>This was the inspiration we needed to figure out if we had tools already in our stack to make this feature possible. That's where <a href="https://github.com/thumbor/thumbor">Thumbor</a> comes in. We already served all of our images through Thumbor to enable us to crop photos and optimize file sizes, but that only scratches the surface of what Thumbor can do.</p>
<h2>Adding watermarks with Thumbor</h2>
<p>We were always aware of <a href="https://thumbor.readthedocs.io/en/latest/filters.html">filters in Thumbor</a>, but until now, we'd never found a good use case. The <a href="https://thumbor.readthedocs.io/en/latest/watermark.html">watermark filter</a> will overlay any image URL you specify and will place the watermark at the x,y coordinates of your choosing. This was exactly what we needed.</p>
<p>Our texastribune.org site runs on Django. In order to keep the filter syntax consistent and straightforward in our templates, we created a <a href="https://docs.djangoproject.com/en/3.1/howto/custom-template-tags/#writing-custom-template-tags">template tag</a> to dynamically build the Thumbor image URLs, based on whether the article was old enough needed a date overlay. That way we could just write something like this in our metadata templates:</p>
<pre class="language-html"><code class="language-html"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">property</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>og:image<span class="token punctuation">"</span></span> <span class="token attr-name">content</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>{% og_image_url article %}<span class="token punctuation">"</span></span><span class="token punctuation">></span></span></code></pre>
<p>And back in our template tag, we build the URL by referencing the watermark image that we've opted to host in s3 for now:</p>
<pre class="language-py"><code class="language-py">generate_url<span class="token punctuation">(</span>image_url<span class="token operator">=</span>article<span class="token punctuation">.</span>meta_art_url<span class="token punctuation">,</span> width<span class="token operator">=</span>width<span class="token punctuation">,</span> height<span class="token operator">=</span>height<span class="token punctuation">,</span> filters<span class="token operator">=</span>watermark<span class="token punctuation">(</span>cdn<span class="token punctuation">.</span>texastribune<span class="token punctuation">.</span>org<span class="token operator">/</span>media<span class="token operator">/</span>watermarks<span class="token operator">/</span><span class="token number">2016.</span>png<span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">30</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span></code></pre>
<p>The <code>generate_url</code> syntax above is referencing the <a href="https://github.com/ricobl/django-thumbor">django-thumbor</a> library.</p>
<h2>Designing the watermarks</h2>
<p>Now that we had a method of programmatically creating the share images with date labels, we needed a streamlined way to generate the overlay graphics for each year. We worked with our talented Art team to come up with a branded concept for the watermark images.</p>
<figure>
  <img src="/images/posts/date-labels-art-inspo.jpg" alt="Screenshot Basecamp conversation in which Emily Albracht posts a mockup of different label designs.">
  <figcaption>Senior Designer, Emily Albracht, offers art direction for our timestamp overlays.</figcaption>
</figure>
<p>With a <a href="https://texastribune.github.io/queso-ui/">CSS framework</a> that matches the styles of our brand already in place, it was then possible to stick to what we know (HTML/CSS) to implement the watermarks' design.</p>
<p>In our CSS framework docs site, which is built with 11ty, we use nunjucks templating to loop through our years of existence as an org and output the date labels with <a href="https://github.com/texastribune/queso-ui/blob/main/docs/src/date-labels.njk#L13-L24">plain ol' HTML/CSS</a>.</p>
<pre class="language-html"><code class="language-html">  {% for year in years %}<br><br>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>has-b-btm-marg<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><br>      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>date-label has-bg-black has-text-white t-weight-bold t-serif t-lh-s<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><br>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>l-align-center-children<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><br>          <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>c-icon has-text-yellow<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>svg</span> <span class="token attr-name">aria-hidden</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>true<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>use</span> <span class="token attr-name"><span class="token namespace">xlink:</span>href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>#bug<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>use</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>svg</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span><br>          <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>has-tiny-btm-marg<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><br>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>span</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>t-size-l<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>em</span><span class="token punctuation">></span></span>from<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>em</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>span</span><span class="token punctuation">></span></span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>span</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>t-size-xxxl<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>{{ year }}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>span</span><span class="token punctuation">></span></span><br>          <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span><br>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span><br>      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span><br>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span><br><br>  {% endfor %}</code></pre>
<p>This creates individual labels that <a href="https://github.com/texastribune/queso-ui/blob/main/docs/config/tasks/date-labels.js">we can then screenshot</a> and export to an s3 bucket.</p>
<figure>
  <img src="/images/posts/date-labels-queso-ss.png" alt="Screenshot The Texas Tribune Queso UI CSS framework site depicting a list of branded date labels of years 2021-2012">
  <figcaption>We use our CSS framework documentation to implement the watermark design with handy helper and utility classes.</figcaption>
</figure>
<h2>Date labels in the wild</h2>
<p>Shortly after launching this feature, Texas was under a national spotlight for <a href="https://www.texastribune.org/2021/02/15/rolling-blackouts-texas/">issues with our state-run electrical grid</a>. That meant we were suddenly getting a good deal of traffic and social reach for this <a href="https://www.texastribune.org/2011/02/08/texplainer-why-does-texas-have-its-own-power-grid/">2011 explainer on why Texas has its own power grid</a>.</p>
<video controls width="400" loop muted>
  <source src="/images/posts/date-labels-video.webm" type="video/webm">
  <source src="/images/posts/date-labels-video.mp4"type="video/mp4">
  Sorry, your browser doesn't support embedded videos.
</video>
<p>People were sharing that article on Twitter and fortunately the date labels were working as expected. That meant we were being transparent about when that article was published and as a bonus established ourselves being historically knowledgeable on the topic.</p>

    </div>
  </article>
</main>

<nav aria-label="pagination" class="post-nav-container t-links t-uppercase t-lsp-b t-size-xs t-align-center t-weight-bold">
  <div class="post-nav">
    <a href="/posts/2021-03-18/">
      <p class="has-text-teal">← Next Post</p>
    </a>
    
  </div>
  <div class="post-nav">
      <a href="/posts/2021-02-22/">
        <p class="has-text-teal">Previous Post →</p>
      </a>
    
  </div>
</nav>

            </div>
            <footer id="main-footer" class="has-bg-black-off has-xs-padding">
    <div class="c-icon c-icon--yellow" style="font-size: 4rem">
        <svg viewBox="0 0 174.9 200" ><path d="M0 0v200l40.2-25.1h134.6V0H0zm125.2 139.7l-38.3-25.2-38.3 25.2 12.1-44.2L25 66.8l45.8-2.1L87 21.8l16.2 42.9 45.8 2.1-35.8 28.6 12 44.3z"></path></svg>
    </div>
</footer>

        </div>
    </body>
</html>
